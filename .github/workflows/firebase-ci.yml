name: SafeDial Backend CI/CD

on:
  push:
    branches: [main]

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout code
        uses: actions/checkout@v3

      - name: 🧰 Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📦 Install dependencies (Linux build)
        run: |
          rm -rf node_modules
          npm install --platform=linux --arch=x64 --force

      - name: 📥 Install Firebase CLI
        run: npm install -g firebase-tools

      - name: 🔐 Authenticate to Google Cloud (service account)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: 🚀 Deploy to Firebase
        id: deploy
        run: |
          firebase deploy --only functions --project=safedial-ca0ba --force --non-interactive | tee deploy.log
          url=$(grep -o 'https://[a-zA-Z0-9./_-]*cloudfunctions.net/[a-zA-Z0-9_-]*' deploy.log | head -n 1)
          echo "DEPLOY_URL=$url" >> $GITHUB_ENV

      - name: ✅ Print deployed API URL
        run: |
          echo "======================================"
          echo "Your backend API is live at:"
          echo "$DEPLOY_URL"
          echo "======================================"

      - name: 📢 Set job summary
        run: |
          echo "## 🚀 SafeDial Backend Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** $DEPLOY_URL" >> $GITHUB_STEP_SUMMARY
